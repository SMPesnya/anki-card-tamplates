<div id="src" style="display:none">{{Source}}</div>
<div id="tgt" style="display:none">{{Target}}</div>

<div class="result"></div>

<div class="pretty">
  <div class="label">Правильный перевод:</div>
  <div class="target">{{Target}}</div>
</div>

<style>
.result{font-size:18px;text-align:center;margin:8px 0 12px}
.pretty .label{font-size:13px;color:#6b7280;text-align:center;margin-top:6px}
.target{font-size:20px;line-height:1.45;text-align:center;margin:6px 0 0}
.line{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin:10px 0}
.bad{background:rgba(239,68,68,.15);border-bottom:2px solid #ef4444;border-radius:6px;padding:2px 6px}
.miss{background:rgba(245,158,11,.15);border-bottom:2px solid #f59e0b;border-radius:6px;padding:2px 6px}
.ok{background:rgba(34,197,94,.15);border-bottom:2px solid #22c55e;border-radius:6px;padding:2px 6px}

</style>

<script>
(function(){
  const src=(document.getElementById('src')?.textContent)||'';
  const tgt=(document.getElementById('tgt')?.textContent)||'';
  const res=document.querySelector('.result');
  if(!res) return;

  function hash(s){let h=2166136261>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=(h*16777619)>>>0;}return h.toString(16)}
  const KEY='sentJS_'+hash(src+'|'+tgt);

  // токенизация: слова (с дефисами/апострофами) + одиночные знаки пунктуации
  function tokenize(s){
    try {
      const re=/([\p{L}\p{N}]+(?:['’\-][\p{L}\p{N}]+)*|[?!.…,;:()\[\]{}«»"“”'—–-])/gu;
      return Array.from(s.matchAll(re), m=>m[0]);
    } catch(_) {
      const re=/([0-9A-Za-z\u0400-\u04FF]+(?:['’-][0-9A-Za-z\u0400-\u04FF]+)*|[?!.…,;:()\[\]{}"'\-])/g;
      return (s.match(re)||[]);
    }
  }

  // какие токены игнорируем (здесь — только запятые)
  function isIgnored(tok){ return tok===',' || tok==='，'; }

  // что набрали на лице
  let typedRaw=''; try{ const saved=JSON.parse(sessionStorage.getItem(KEY)||'{}'); typedRaw=saved.raw||''; }catch(_){}

  // исходные токены
  const tAll = tokenize(typedRaw).filter(x=>x.trim()!=='');
  const eAll = tokenize(tgt).filter(x=>x.trim()!=='');

  // для сравнения — фильтруем только запятые
  const tA = tAll.filter(tok=>!isIgnored(tok));
  const eA = eAll.filter(tok=>!isIgnored(tok));

  const max = Math.max(tA.length, eA.length);
  let okAll = (tA.length===eA.length) && tA.every((x,i)=>x===eA[i]);

  const line = document.createElement('div'); line.className='line';
  for(let i=0;i<max;i++){
    const t = tA[i]; const e = eA[i];
    if(t===undefined && e!==undefined){
      const span=document.createElement('span'); span.className='miss'; span.textContent=e;
      line.appendChild(span); okAll=false;
    }else if(t!==undefined && e===undefined){
      const span=document.createElement('span'); span.className='bad'; span.textContent=t;
      line.appendChild(span); okAll=false;
    }else{
      const span=document.createElement('span');
      if(t===e){ span.className='ok'; span.textContent=t; }
      else { span.className='bad'; span.textContent=t; okAll=false; }
      line.appendChild(span);
    }
  }

  res.textContent = okAll ? 'Отлично! Совпало.' : 'Есть расхождения:';
  res.after(line);

  // очистка сохранённого ввода
  try{ sessionStorage.removeItem(KEY); }catch(_){}
})();
</script>



